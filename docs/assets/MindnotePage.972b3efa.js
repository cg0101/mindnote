import{j as e,v as t,o as i,b as n,k as s,i as a,p as l,f as o,r as h,g as r,F as c,h as d,l as p,e as m}from"./vendor.7204fa68.js";import{a as u,r as g,g as v,s as f}from"./util.9e521194.js";const b={name:"MindnoteInput",props:{value:Object},data(){return{isSelected:!1,message:this.value,styleObject:{width:"200px"}}},watch:{value:function(e,t){console.log("Prop changed: ",e," | was: ",t),this.message=this.value}},mounted(){this.checkWidth()},methods:{pressEnter:function(){console.log("input > pressEnter",this),this.$emit("hit-enter",this)},pressTab:function(){console.log("input > pressTab"),this.$emit("hit-tab",this)},pressDelete:function(){console.log("input > pressDelete"),""==this.value.name&&this.$emit("hit-delete",this)},hitInput:function(){console.log("hitInput"),this.checkWidth(),this.$emit("press-input",this.treeData)},checkWidth(){if(this.$refs&&this.$refs.inputElment){const e=6;let t=this.$refs.inputElment.offsetWidth;const i=this.$refs.inputElment.scrollWidth;i>t&&(t=i+e);window.innerWidth-t>50&&(this.styleObject.width=t+"px")}}}},x=a("data-v-12a857bc")(((a,l,o,h,r,c)=>e((i(),n("input",{class:{isSelected:r.isSelected},ref:"inputElment",autocomplete:"false",spellcheck:"false",onInput:l[1]||(l[1]=(...e)=>c.hitInput&&c.hitInput(...e)),onKeydown:[l[2]||(l[2]=s(((...e)=>c.pressEnter&&c.pressEnter(...e)),["enter"])),l[3]||(l[3]=s(((...e)=>c.pressTab&&c.pressTab(...e)),["tab"])),l[4]||(l[4]=s(((...e)=>c.pressDelete&&c.pressDelete(...e)),["delete"]))],"onUpdate:modelValue":l[5]||(l[5]=e=>r.message.name=e),style:r.styleObject},null,38)),[[t,r.message.name]])));b.render=x,b.__scopeId="data-v-12a857bc";const I={name:"MindnoteItem",components:{MindnoteInput:b},props:["item"],data(){return{isOpen:!0,value:this.item}},watch:{item:function(e,t){console.log("Prop changed: ",e," | was: ",t),this.value=this.item}},computed:{isFolder:function(){return this.value.children&&this.value.children.length}},methods:{toggle:function(){console.log("item > toggle"),this.isOpen=!this.isOpen},enterItem:function(e){console.log("item > enterItem",this,e),this.$emit("hit-enter",this)},tabItem:function(){console.log("item > tabItem"),this.$emit("hit-tab",this)},deleteItem:function(e){console.log("item > deleteItem",this,e),this.$emit("hit-delete",this)},inputContent:function(){console.log("item > inputContent",this),this.$emit("press-input")}}},y=a("data-v-2cf79249");l("data-v-2cf79249");const S={class:"line-item"},D=r("div",{class:"dot"},null,-1);o();const $=y(((e,t,s,a,l,o)=>{const c=h("mindnote-input");return i(),n("div",S,[r("div",{class:["bullet",{folder:!o.isFolder}],onClick:t[1]||(t[1]=(...e)=>o.toggle&&o.toggle(...e))},[D],2),r(c,{class:"line-content",value:l.value,onHitEnter:o.enterItem,onHitTab:o.tabItem,onHitDelete:o.deleteItem,onPressInput:o.inputContent,ref:"inputitem"},null,8,["value","onHitEnter","onHitTab","onHitDelete","onPressInput"])])}));I.render=$,I.__scopeId="data-v-2cf79249";const M={props:["propsitem"],components:{MindnoteItem:I},data:()=>({isOpen:!0,treeData:[{id:1,name:"Untitled"}]}),beforeMount(){this.propsitem&&this.propsitem.length?this.treeData=this.propsitem:this.treeData=[{id:1,name:"Untitled"}]},watch:{propsitem:function(e,t){console.log("Prop changed: ",e," | was: ",t),this.treeData=this.propsitem}},methods:{toggle(){console.log("child > toggle"),this.isOpen=!this.isOpen},enterItem(e){console.log("child > enterItem",this);const t=e._.vnode.key,i=e.$parent.treeData.length,n=t+1,s={id:i,name:"",remark:"",children:[]},a=e.$parent.treeData;a&&a.length>=1&&!a[n-1].name?e.$parent.$parent&&e.$parent.$parent.treeData&&(e.$parent.$parent.treeData.push(s),this.$emit("press-input"),this.$nextTick((()=>this.$el.parentElement.parentElement.nextElementSibling.querySelector("input").focus()))):(this.treeData.splice(n,0,s),this.$nextTick((()=>this.$el.children[n].querySelector("input").focus())),this.$emit("press-input"))},addSubitem(){console.log("child > addSubitem",this.treeData),this.$emit("add-subitem",this.treeData),this.isOpen=!0},tabItem(e){console.log("child > tabItem",e);const t=e._.vnode.key;if(t){const i=e._.vnode.key-1,n=e.$parent.treeData[i];n.children||(n.children=[]),n.children.push(e.value),e.$parent.treeData.splice(t,1),this.$emit("press-input"),setTimeout((()=>{this.$el.querySelector(".mindnote-children").querySelector("input").focus()}),100)}else console.log("child > tabItem > input > focus")},deleteItem(e){console.log("child > deleteItem",this.treeData);const t=e._.vnode.key;e.$parent.treeData.splice(t,1),this.$emit("delete-item"),this.$nextTick((()=>{setTimeout((()=>{let e=this.$el.parentElement.querySelectorAll(".line-item");e[e.length-1].querySelector("input").focus()}),100)}))},inputContent(){console.log("child > inputContent",this),this.$emit("press-input")}}},T=a("data-v-00acb4b8");l("data-v-00acb4b8");const w={class:"mindnote"},C={key:0,class:"mindnote-children"},H=r("div",{class:"mindnote-children__connection"},null,-1);o();const P=T(((t,s,a,l,o,u)=>{const g=h("mindnote-item"),v=h("_self");return i(),n("div",w,[(i(!0),n(c,null,d(o.treeData,((t,s)=>(i(),n("div",{key:s,ref:"treeData"},[r(g,{key:s,ref:"mindnoteTree",item:t,onHitEnter:u.enterItem,onHitTab:u.tabItem,onHitDelete:u.deleteItem,onPressInput:u.inputContent},null,8,["item","onHitEnter","onHitTab","onHitDelete","onPressInput"]),t.children&&t.children.length?e((i(),n("div",C,[H,r(v,{propsitem:t.children,onPressInput:u.inputContent,onAddSubitem:u.inputContent},null,8,["propsitem","onPressInput","onAddSubitem"])],512)),[[p,o.isOpen]]):m("",!0)],512)))),128))])}));M.render=P,M.__scopeId="data-v-00acb4b8";l("data-v-0b631898"),o();var _={textFilter:{label:"Text Filter (regex)",type:"text",val:"."},fontSize:{label:"Font size",model:"fontSize",min:5,max:50,val:13},connectorWidth:{label:"Connector width",model:"connectorWidth",min:20,max:100,val:65},connectorSteepness:{label:"Connector steepness",min:.1,max:1,step:.01,val:.65},connectorLineWidth:{label:"Line width",min:.5,max:10,step:.25,val:4.5},nodeMarginTop:{label:" Top margin",min:0,max:50,val:5},nodeMarginBottom:{label:" Bottom margin",min:0,max:50,val:5},useGrayscale:{label:"Use grayscale",type:"boolean",val:0}};class L{constructor(e,t=!1){this.label=e,this.labelLines=this.label.split("\n"),this.isRoot=t,this.parent=void 0,this.children=[]}get isLeaf(){return 0==this.children.length}addChild(e){e.parent=this,this.children.push(e)}addChildren(...e){for(var t of e)this.addChild(t)}draw(e){if(this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.ctx.font=_.fontSize.val+"px Open Sans",this.textHeight=_.fontSize.val*this.labelLines.length,this.composedHeight=this.textHeight+8+_.connectorLineWidth.val,this.paddedHeight=this.composedHeight+_.nodeMarginTop.val,this.labelHeight=_.nodeMarginTop.val+_.fontSize.val*(this.labelLines.length+1)+_.nodeMarginBottom.val,this.labelWidth=Math.ceil(Math.max(...this.labelLines.map((e=>this.ctx.measureText(e).width)))),this.isLeaf){this.canvas.width=this.labelWidth+20,this.canvas.height=this.labelHeight,this.ctx.font=_.fontSize.val+"px Open Sans";for(var t=0;t<this.labelLines.length;t++)this.ctx.fillText(this.labelLines[t],0,_.fontSize.val*(t+1)+_.nodeMarginTop.val);this.anchorPoint={x:0,y:this.labelLines.length*_.fontSize.val+8+_.nodeMarginTop.val}}else{if(this.isRoot)var i=this.children.map((e=>u(_.useGrayscale))),n=this.children.map(((e,t)=>e.draw(i[t])));else n=this.children.map(((t,i)=>t.draw(e)));var s=[0];for(t=0;t<n.length;t++)s[t+1]=s[t]+n[t].height;let h=s[n.length];this.anchorPoint={x:this.isRoot?10:0,y:0},h<this.composedHeight+2*_.nodeMarginTop.val?(this.canvas.height=this.composedHeight+2*_.nodeMarginTop.val,this.anchorPoint.y=this.canvas.height/2+this.composedHeight/2):(this.canvas.height=Math.max(s[n.length],2*this.composedHeight),this.anchorPoint.y=this.canvas.height/2),console.log(this.label,this.canvas.height,s[n.length]);var a=10+this.labelWidth+_.connectorWidth.val;this.canvas.width=a+Math.max(...n.map((e=>e.width))),this.ctx.font=_.fontSize.val+"px Open Sans";for(t=0;t<n.length;t++){this.isRoot&&(e=i[t]),this.ctx.drawImage(n[t],a,s[t]);var l={x:this.anchorPoint.x+this.labelWidth+10,y:this.anchorPoint.y},o={x:a,y:s[t]+this.children[t].anchorPoint.y};this.ctx.beginPath(),this.ctx.moveTo(l.x,l.y),this.ctx.bezierCurveTo(l.x+_.connectorSteepness.val*_.connectorWidth.val,l.y,o.x-_.connectorSteepness.val*_.connectorWidth.val,o.y,o.x,o.y),this.ctx.lineTo(o.x+this.children[t].labelWidth+10,o.y),this.ctx.lineWidth=_.connectorLineWidth.val,this.ctx.lineCap="round",this.ctx.strokeStyle=e,this.ctx.stroke()}if(this.isRoot){this.ctx.fillStyle="#ffffff",this.ctx.lineWidth=3,g(this.ctx,2,this.canvas.height/2-this.labelLines.length*_.fontSize.val,this.labelWidth+18,_.fontSize.val*(this.labelLines.length+1.5),5,!0,!0),this.ctx.fillStyle="#000000";for(t=0;t<this.labelLines.length;t++)this.ctx.fillText(this.labelLines[t],10,this.canvas.height/2+_.fontSize.val/2-_.fontSize.val*(this.labelLines.length-t-1))}else{this.ctx.fillStyle="#000000";for(t=0;t<this.labelLines.length;t++)this.ctx.fillText(this.labelLines[t],10,this.anchorPoint.y-8-_.fontSize.val*(this.labelLines.length-t-1))}}return this.canvas}}function k(e){for(var t in this.el=e.el,this.currentTree=void 0,this.treeProperties={},this.sourceCode=e.sourceCode,_)this.treeProperties[t]=_[t].val;this.parseSource()}k.prototype={parseSource:function(){console.log("Parsing...");try{console.log(222),console.log(this.sourceCode);var e=function(e){var t={label:"ROOT",children:[],depth:-1},i=e.split("\n");i=i.filter((e=>!e.match(/^\s*$/)));var n,s=t,a=-1,l="";for(var o of i){var h=o.match(/^( *)-\s*(.*)$/);if(h){if(""!=l){var r={label:l,children:[],parent:s,depth:n};s.children.push(r),s=r,a=r.depth}for(n=h[1].length,l=h[2];n<=a;)a=(s=s.parent).depth}else l+="\n"+o}l&&(r={label:l,children:[],parent:s,depth:a+1},s.children.push(r));return t}(this.sourceCode);console.log(e)}catch(t){return void console.log("Error sourceCode parse fail")}if(0!=e.children.length){e=e.children[0];try{""!=_.textFilter.val?this.textFilter=new RegExp(_.textFilter.val):this.textFilter=new RegExp(".+")}catch(t){return void console.log(t)}this.currentTree=this.parseObjectBranch(e,!0),this.regenerateDiagram()}},parseObjectBranch:function(e,t=!1){var i=new L(e.label,t);for(var n of e.children)this.textFilter.test(n.label)&&i.addChild(this.parseObjectBranch(n,!1));return i},regenerateDiagram:function(){var e=this.el,t=e.getContext("2d");if(this.currentTree instanceof L){var i=this.currentTree.draw();e.width=i.width+25,e.height=i.height+25,t.drawImage(i,25,25)}else console.log("Not a valid tree",this.currentTree)},buildGlobalProperties:function(){for(var e in _)_[e].val="textFilter"!=e?Number(this.treeProperties[e]):this.treeProperties[e];this.parseSource()}};const E={name:"MindnotePage",components:{Mindnote:M},data(){return{isHideMindmap:!0,title:this.getDefaultTitle(),listItemData:[],rootItem:{name:"Untitled"}}},created(){this.getData(),this.$nextTick((()=>this.$refs.title.focus()))},methods:{viewMindmap(){this.isHideMindmap=!1;let e=this.buildSourceCode(this.listItemData,["- "+this.title],{depth:0}).join("\n");new k({el:this.$refs.mindmap,sourceCode:e})},buildSourceCode(e,t,i={}){let n=[];return n.push(e),n&&n.forEach((e=>{e.forEach((e=>{let n="";if(i.depth>=0)for(let t=0;t<=i.depth;t++)n="  "+n;t.push(n+`- ${e.name}`),e.children&&e.children.length&&this.buildSourceCode(e.children,t,{depth:i.depth+1})}))})),t},getData(){const e=v(this.getMindnoteId());this.listItemData=e},saveMindnote(){console.log("saveMindnote",this.listItemData),f(this.getMindnoteId(),this.listItemData)},getMindnoteId(){return this.$route.params.mindnoteId},getDefaultTitle(){let e=this.fetchMindnoteById(this.getMindnoteId());return e?e.name:""},fetchMindnoteById(e){return this.fetchLocalDb().find((t=>t.id==e))},fetchLocalDb:()=>v("z-mindnoteItems"),onTitleChange(){let e=this.fetchLocalDb(),t=this.fetchMindnoteById(this.getMindnoteId()),i=e.findIndex((e=>e.id==t.id));t&&(t.name=this.title,e[i]=t,f("z-mindnoteItems",e))}},mounted(){}},W=a("data-v-4f6c3412");l("data-v-4f6c3412");const O={class:"pape-mindnote"},z={class:"pape-mindnote__bd"},F={class:"pape-mindnote__bd__title"},j={class:"pape-mindnote__bd__tree"},B={class:"page-mindnote__mindmap"},R={ref:"mindmap"};o();const q=W(((s,a,l,o,c,d)=>{const m=h("mindnote");return i(),n("div",O,[r("div",z,[e(r("a",{class:"btn-view-mindmap",onClick:a[1]||(a[1]=(...e)=>d.viewMindmap&&d.viewMindmap(...e))},"查看关系图",512),[[p,c.isHideMindmap]]),e(r("a",{class:"btn-view-mindmap",onClick:a[2]||(a[2]=e=>c.isHideMindmap=!0)},"关闭",512),[[p,!c.isHideMindmap]]),r("div",F,[e(r("input",{type:"text",placeholder:"无标题","onUpdate:modelValue":a[3]||(a[3]=e=>c.title=e),onChange:a[4]||(a[4]=(...e)=>d.onTitleChange&&d.onTitleChange(...e)),ref:"title",class:"input-title"},null,544),[[t,c.title]])]),r("div",j,[r(m,{class:"mindnote",ref:"mindnote",propsitem:c.listItemData,onPressInput:d.saveMindnote,onAddSubitem:d.saveMindnote,onDeleteItem:d.saveMindnote},null,8,["propsitem","onPressInput","onAddSubitem","onDeleteItem"])]),e(r("div",B,[r("canvas",R,null,512)],512),[[p,!c.isHideMindmap]])])])}));E.render=q,E.__scopeId="data-v-4f6c3412";export default E;
